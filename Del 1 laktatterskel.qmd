---
title: "Del 1: Laktatterskel"
format: html
editor_options: 
  chunk_output_type: console
---

# Del 1: Laktatterskel

Vi valgte å bruke cyclingstudy datasettet med tanke på at vi ikke testet laktatprofiler under reliabilitets-prosjektet vårt. Dette datasettet inneholder data fra 21 forsøkspersoner, der de fleste har gjennomført en laktatprofil på fire ulike tidspunkt: pre, meso1, meso2 og meso3. Vi har valgt å plukke ut forsøksperson 10, og sett på laktatprofilen på pre-test og meso3.  

```{r}

library(tidyverse)
library(exscidata)
library(gt)
library(modelr)
library(gtExtras)

# Importert datasett

data("cyclingstudy")


```


## Laktatprofil til forsøksperson 10 "Pre" test:

```{r}

cyclingstudy %>%
  select(subject, group, timepoint, lac.125:lac.375) %>%
  filter(timepoint == "pre", subject == 10) %>%
  pivot_longer(names_to = "watt", 
               values_to = "lactate", 
               names_prefix = "lac.",
               names_transform = list(watt = as.numeric),
               cols = lac.225:lac.375) %>%  
  filter(!is.na(lactate)) %>%
  ggplot(aes(watt, lactate, group = subject))  + 
  geom_line(lty = 2) +
  geom_point(shape = 21, fill = "lightblue", size = 2.5) 
```


## Laktatterskel "pre-test"

```{r}

Laktatterskel <- cyclingstudy %>%
  select(subject, group, timepoint, lac.125:lac.375) %>%
  filter(timepoint == "pre", subject == 10) %>%
  pivot_longer(names_to = "watt", 
               values_to = "lactate", 
               names_prefix = "lac.",
               names_transform = list(watt = as.numeric),
               cols = lac.125:lac.375) %>%
  filter(!is.na(lactate))

mod_laktatterskel <- lm(lactate ~ poly(watt, 3, raw = TRUE), data = Laktatterskel)

Laktatterskel %>% 
  ggplot(aes(watt, lactate, group = subject)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE, formula = y ~ poly(x, 3), color = "#4daf4a")

wattdata <- data.frame(watt = seq(from = 125, to = 375, by = 0.1))

wattdata$pred <- predict(mod_laktatterskel, newdata = wattdata) 

lactate.pre <- wattdata %>% 
  filter(abs(pred - 2) == min(abs(pred - 2)) |
           abs(pred - 4) == min(abs(pred - 4))) %>% 
  mutate(timepoint = "pre",
         lactate = "2mmol")

lactate.pre[2, 4] <- "4mmol" 


```

### På "Pre-test" sykler forsøkspersonen på 307 W ved en laktatverdi på 2 mmol, og på 343 W ved en laktatverdi på 4 mmol.


## Laktatterskel "pre-test"

```{r}

LT <- cyclingstudy %>%
  select(subject, group, timepoint, lac.225:lac.375) %>%
  filter(timepoint == "pre", subject == 10) %>%
  pivot_longer(names_to = "watt", 
               values_to = "lactate", 
               names_prefix = "lac.",
               names_transform = list(watt = as.numeric),
               cols = lac.225:lac.375) %>%  
  filter(!is.na(lactate)) %>% 
  data.frame()

polymodel <- lm(lactate ~ poly(watt, 3, raw = TRUE), data = LT)

delta_mod <- lm(lactate ~ watt, data = filter(LT, watt %in% c(min(watt), max(watt))))

d1 <- coef(polymodel) [2]
d2 <- coef(polymodel) [3]
d3 <- coef(polymodel) [4]
delta <- coef(delta_mod) [2]

poly_threshold <- (-d2 + sqrt((d2^2 - 3 * d3 * (d1 - delta)) )) / (3 * d3)

LT %>% 
  ggplot(aes(watt, lactate)) + 
  geom_smooth(method = "lm", formula = y ~ poly(x, 3),
              se = FALSE,
              color = "steelblue") +
  geom_segment(aes(y = pull(filter(LT, watt == min(watt)), lactate), 
                   yend = pull(filter(LT, watt == max(watt)), lactate),
                   x = min(watt),
                   xend = max(watt)),
                   color = "steelblue",
                   linewidth = 1) + 
  geom_segment(aes(y = predict(polymodel, newdata = data.frame(watt = poly_threshold)),
                   yend = 0,
                   x = poly_threshold,
                   xend = poly_threshold),
               color = "red", lty = 2,
               arrow = arrow(type = "closed", length = unit(4, "mm"))) + 
  geom_point()


```


## Laktatprofil ved Meso3

```{r}

cyclingstudy %>%
  select(subject, group, timepoint, lac.125:lac.375) %>%
  filter(timepoint == "meso3", subject == 10) %>%
  pivot_longer(names_to = "watt", 
               values_to = "lactate", 
               names_prefix = "lac.",
               names_transform = list(watt = as.numeric),
               cols = lac.225:lac.375) %>%  
  filter(!is.na(lactate)) %>% 
  ggplot(aes(watt, lactate, group = subject))  + 
  geom_line(lty = 2) +
  geom_point(shape = 21, fill = "lightblue", size = 2.5) 

```

## Laktatterskel meso3

```{r}
LT2 <- cyclingstudy %>%
  select(subject, group, timepoint, lac.225:lac.375) %>%
  filter(timepoint == "meso3", subject == 10) %>%
  pivot_longer(names_to = "watt", 
               values_to = "lactate", 
               names_prefix = "lac.",
               names_transform = list(watt = as.numeric),
               cols = lac.225:lac.375) %>%  
  filter(!is.na(lactate)) %>% 
  data.frame()

polymodel <- lm(lactate ~ poly(watt, 3, raw = TRUE), data = LT2)

delta_mod <- lm(lactate ~ watt, data = filter(LT, watt %in% c(min(watt), max(watt))))

d1 <- coef(polymodel) [2]
d2 <- coef(polymodel) [3]
d3 <- coef(polymodel) [4]
delta <- coef(delta_mod) [2]

poly_threshold <- (-d2 + sqrt((d2^2 - 3 * d3 * (d1 - delta)) )) / (3 * d3)

LT2 %>% 
  ggplot(aes(watt, lactate)) + 
  geom_smooth(method = "lm", formula = y ~ poly(x, 3),
              se = FALSE,
              color = "steelblue") +
  geom_segment(aes(y = pull(filter(LT, watt == min(watt)), lactate), 
                   yend = pull(filter(LT, watt == max(watt)), lactate),
                   x = min(watt),
                   xend = max(watt)),
                   color = "steelblue",
                   linewidth = 1) + 
  geom_segment(aes(y = predict(polymodel, newdata = data.frame(watt = poly_threshold)),
                   yend = 0,
                   x = poly_threshold,
                   xend = poly_threshold),
               color = "red", lty = 2,
               arrow = arrow(type = "closed", length = unit(4, "mm"))) +
  geom_point() 


```

## Laktatterskel meso3

```{r}
Laktatterskel.meso3 <- cyclingstudy %>%
  select(subject, group, timepoint, lac.125:lac.375) %>%
  filter(timepoint == "meso3", subject == 10) %>%
  pivot_longer(names_to = "watt", 
               values_to = "lactate", 
               names_prefix = "lac.",
               names_transform = list(watt = as.numeric),
               cols = lac.125:lac.375) %>%
  filter(!is.na(lactate))


mod_laktatterskel.meso3 <- lm(lactate ~ poly(watt, 3, raw = TRUE), data = Laktatterskel.meso3)

Laktatterskel.meso3 %>% 
  ggplot(aes(watt, lactate, group = subject)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE, formula = y ~ poly(x, 3), color = "#4daf4a")

wattdata.meso3 <- data.frame(watt = seq(from = 125, to = 375, by = 0.1))

wattdata.meso3$pred <- predict(mod_laktatterskel.meso3, newdata = wattdata.meso3)

lactate.meso3 <- wattdata.meso3 %>% 
  filter(abs(pred - 2) == min(abs(pred - 2)) |
           abs(pred - 4) == min(abs(pred - 4))) %>% 
  mutate(timepoint = "meso3",
         lactate = "2mmol")

lactate.meso3[2, 4] <- "4mmol"

```

### På Meso3 sykler forsøkspersonen på 310 W ved en laktatverdi på 2 mmol, og på 344 W ved en laktatverdi på 4 mmol.




